rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection - stores user profiles and roles
    match /users/{userId} {
      // Users can read their own profile, admins can read all profiles
      allow read: if request.auth != null && 
                   (request.auth.uid == userId || isAdmin());
      
      // Users can create their own profile on first login
      allow create: if request.auth != null && 
                     request.auth.uid == userId &&
                     request.resource.data.role == 'user'; // Default role must be 'user'
      
      // Users can update their own profile (except role field)
      // Only admins can update role field
      allow update: if request.auth != null && 
                     (request.auth.uid == userId && 
                      request.resource.data.role == resource.data.role) ||
                     isAdmin();
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // Projects collection
    match /projects/{projectId} {
      // Users can read their own projects, admins can read all projects
      allow read: if request.auth != null && 
                   (resource.data.userId == request.auth.uid || isAdmin());
      
      // Users can create projects with their own userId
      allow create: if request.auth != null && 
                     request.resource.data.userId == request.auth.uid;
      
      // Users can update their own projects, or admins can update any project
      allow update: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Users can delete their own projects, admins can delete any
      allow delete: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Books collection
    match /books/{bookId} {
      // Function to check if user owns the project this book belongs to
      function ownsProject() {
        return request.auth != null && 
               resource.data.projectId != null &&
               exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
               get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.userId == request.auth.uid;
      }
      
      // Users can read their own books or books in their projects, admins can read all books
      allow read: if request.auth != null && 
                   (resource.data.userId == request.auth.uid || 
                    ownsProject() || 
                    isAdmin());
      
      // Users can create books in their projects
      allow create: if request.auth != null && 
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.projectId != null &&
                     exists(/databases/$(database)/documents/projects/$(request.resource.data.projectId)) &&
                     get(/databases/$(database)/documents/projects/$(request.resource.data.projectId)).data.userId == request.auth.uid;
      
      // Users can update books in their projects, or admins can update any book
      allow update: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || 
                      ownsProject() ||
                      isAdmin());
      
      // Users can delete books in their projects, admins can delete any
      allow delete: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || 
                      ownsProject() ||
                      isAdmin());
      
      // Report B subcollection - Quality Check Reports
      match /reportB/{document=**} {
        // Anyone authenticated can read Report B
        allow read: if request.auth != null;
        
        // Only admins can write (upload/update) Report B
        allow write: if request.auth != null && isAdmin();
      }
      
      // Report B Feedback subcollection
      match /reportB_feedback/{feedbackId} {
        // Users can only read their own feedback
        allow read: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
        
        // Users can create their own feedback
        allow create: if request.auth != null && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can update their own feedback
        allow update: if request.auth != null && 
                         resource.data.userId == request.auth.uid &&
                         request.resource.data.userId == request.auth.uid;
        
        // Users can delete their own feedback
        allow delete: if request.auth != null && 
                         resource.data.userId == request.auth.uid;
      }
      
      // Report B Manual Issues subcollection
      match /reportB_manualIssues/{issueId} {
        // Users can only read their own manual issues
        allow read: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
        
        // Users can create their own manual issues
        allow create: if request.auth != null && 
                         request.resource.data.userId == request.auth.uid;
        
        // Users can update their own manual issues
        allow update: if request.auth != null && 
                         resource.data.userId == request.auth.uid &&
                         request.resource.data.userId == request.auth.uid;
        
        // Users can delete their own manual issues
        allow delete: if request.auth != null && 
                         resource.data.userId == request.auth.uid;
      }
    }
  }
}
